{% extends 'header.html' %}
{% block app-content %}
<style>
    ul { padding-left:20px; list-style:none; }
    li { margin-bottom:10px; }
    hr {
        display: block;
        margin-top: 0.5em;
        margin-bottom: 0.5em;
        margin-left: auto;
        margin-right: auto;
        border-style: inset;
        border-width: 1px;
    }
    .pending-update { background-color: pink }
</style>
<link rel="stylesheet" href="css/form-style.css">
<div ng-app="myApp">
    <div id="idMyCtrl" ng-controller="myCtrl">
        <div class="container">
            <div class="center-block">
                    <!-- Buttons -->
                    <div class="form-group">
                        <div class="control buttons">
                            <button
                                    type="submit"
                                    class="btn btn-warning"
                                    ng-click="updateChanges(activeConf)"
                                    ng-disabled="!myForm.modified"
                                    >
                                Update Changes
                            </button>
                            <button
                                    type="button"
                                    class="btn btn-primary"
                                    ng-disabled="!myForm.modified"
                                    ng-click="syncLatestFromServer(activeConf)"
                                    >
                                Reset Changes
                            </button>
                            <div class="btn-group dropdown"> <a class="btn btn-default dropdown-toggle btn-select2" data-toggle="dropdown" href="#">Select Config <span class="caret"></span></a>
                            </div>
                        </div>
                    </div>
                    <!-- Buttons End -->

                    <!-- Tree View of Conf Data -->
                    <form name="myForm" novalidate>
                        <div class="row">
                                <table>
                                    <tr>
                                        <td><json-tree json="jsonData" node="nodeOptions" edit-level="low" collapsed-level="3"></json-tree></td>
                                    </tr>
                                </table>
                        </div>
                    </form>
                    <!-- Tree View of Conf Data End -->
            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.16/angular.min.js"></script>
<script src="vendor/angular/json-tree.js"></script>
<script src="vendor/angular/angular-input-modified.js"></script>
<script>
    (function(){

        var myApp = angular.module('myApp', ['json-tree', 'ngInputModified']);

        myApp.controller('myCtrl', ['$scope', '$http', function($scope, $http) {
                $scope.activeConf = 0;

                $http.get('controls/api/0').
                        success(function (data) {
                            $scope.jsonData = data;
                            $scope.nodeOptions.refresh();
                        }).error(function () {
                            alert("Server error while loading conf file!");
                        });

                // Needed for the first view to be created.
                function defaultData() {
                    return {
                    };
                }

                $scope.jsonData = defaultData();

                $scope.updateChanges = function(id){
                    $scope.myForm.$setPristine();
                    $http({
                        url: 'controls/api/' + id,
                        method: "POST",
                        data: JSON.stringify($scope.jsonData),
                        headers: {'Content-Type': 'application/json'}
                    }).success(function (data, status, headers, config) {
                    }).error(function (data, status, headers, config) {
                        alert("Server error!");
                    });
                }

                $scope.syncLatestFromServer = function(id){
                    $http.get('controls/api/' + id).
                            success(function (data) {
                                $scope.jsonData = data;
                                $scope.myForm.modified = false;
                                $scope.nodeOptions.refresh();
                            }).error(function () {
                                alert("Server error!");
                            });
                }
        }])
    })();

    var conf_items = [];
    $.getJSON( "controls/api/confs", function( data ) {
        $.each( data, function( index, val ) {
            conf_items.push( "<li><a href=\"#\" id=\'" + index + "\'>" + val + "</a></li>" );
        });
    });

    jQuery(document).ready(function() {
        $('.dropdown').on('click','a[data-toggle="dropdown"]',
                function(){
                    //if($(this).children().length <= 0){
                        $(this).after( '<ul class="dropdown-menu" role="menu" aria-labelledby="dLabel" >' + conf_items.join("") + '</ul>' );
                        $(this).dropdown();
                    //}
                });

        $('.dropdown').on('click', '.dropdown-menu li a', function () {
            angular.element('#idMyCtrl').scope().activeConf = $(this).attr("id");
            angular.element('#idMyCtrl').scope().syncLatestFromServer($(this).attr("id"));
        });
    });
</script>
{% endblock %}